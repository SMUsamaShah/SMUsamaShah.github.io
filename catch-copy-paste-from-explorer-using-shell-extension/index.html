<!DOCTYPE html>
<html lang="en-us">
  <head>
	<title>How to get windows copy paste events with shell hook. | XOSH.ORG</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="How to get windows copy paste events with shell hook.">

	<meta property="og:url" content="https://xosh.org/catch-copy-paste-from-explorer-using-shell-extension/">
  <meta property="og:site_name" content="XOSH.ORG">
  <meta property="og:title" content="How to get windows copy paste events with shell hook.">
  <meta property="og:description" content="How to get windows copy paste events with shell hook.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2017-10-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2017-10-11T00:00:00+00:00">
    <meta property="og:image" content="https://xosh.org/site-feature-image.jpg">

	
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://xosh.org/site-feature-image.jpg">
  <meta name="twitter:title" content="How to get windows copy paste events with shell hook.">
  <meta name="twitter:description" content="How to get windows copy paste events with shell hook.">

	
	<script data-ad-client="ca-pub-6900458819212175" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<meta name="google-site-verification" content="fcsy6xwzGDIwyzoNhlebWTJvbkmQNzPNwrpy0YpIqHI"/>
	
  
    
      
    
  


	
	
    
    
        <script type="application/ld+json">
        
        { 
            "@context": "http://schema.org", 
            "@type": "BlogPosting",
            "headline": "How to get windows copy paste events with shell hook.",
            "genre": "",  
            "url": "https:\/\/xosh.org\/catch-copy-paste-from-explorer-using-shell-extension\/",
            "datePublished": "2017-10-11 00:00:00 \u002b0000 UTC",
            "description": "How to get windows copy paste events with shell hook.",
            "author": {
                "@type": "Person",
                "name": ""
            }
         }
        
        </script>
    
	
	
	<link rel="stylesheet" href="/css/style.css" />
    
    <link rel="stylesheet" href="https://xosh.org/css/custom.css">
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://xosh.org/">~/xosh.org</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/rss</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">How to get windows copy paste events with shell hook.</span></h1>

<date class="date">2017/10/11</date>
<p class="terms">
  
  
  
  
  
</p>
</div>


<div class="content-wrapper">
  <main>
    <p>This article was originally posted <a href="http://www.mywingsoflove.com/2009/11/12/howto-handle-copy-paste-from-explorer-using-shell-extension-icopyhook-alternative/">here</a> by the author, that is <a href="https://web.archive.org/web/20120502020845/http://www.mywingsoflove.com/2009/11/12/howto-handle-copy-paste-from-explorer-using-shell-extension-icopyhook-alternative/">no longer available</a>.</p>
<h1 id="how-to-catch-copy-paste-from-explorer-using-shell-extension-icopyhook-alternative-for-files-and-folder">How to catch copy paste from explorer using shell extension? ICopyHook alternative for files and folder</h1>
<p>How to catch copy paste from explorer using shell extension? ICopyHook alternative for files and folder
Howto trap copy paste event from explorer to do your custom processing or even
Howto replace/substitute the copy-paste/cut-paste operation with your own copy or move or anything else?</p>
<p>Yes, tracking copy paste operation is possible using <a href="https://msdn.microsoft.com/en-us/library/bb776881(VS.85).aspx#dragdrop">DragDropHandlers</a> i.e. just by implementing IShellExtInit &amp; IContextMenu:</p>
<p>Technique in brief with code snippet:</p>
<ol>
<li>Use IShellExtInit::Initialize to save the source files and destination folder â€“ you get this data from LPCITEMIDLIST and LPDATAOBJECT in parameter to method.</li>
<li>Most important part, implement IContextMenu::QueryContextMenu to substitute default menu item for copy paste or cut paste event from explorer</li>
<li>In IContextMenu::InvokeCommand write your implementation for copy-paste/cut-paste event from explorer.</li>
</ol>
<p>The code snippet below shows how to get source file names, destination folder name involved in copy paste operation (see TrapCopy::Initialize method below), how to direct the default copy paste event to your custom one (see TrapCopy::QueryContextMenu and TrapCopy::InvokeCommand)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    STDMETHODIMP TrapCopy<span style="color:#f92672">::</span>Initialize(LPCITEMIDLIST pidlFolder,
</span></span><span style="display:flex;"><span>                                      LPDATAOBJECT pDO,
</span></span><span style="display:flex;"><span>                                      HKEY hProgID)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Look for CF_HDROP data in the data object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// If there is no such data, return an error back to Explorer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        FORMATETC fmt <span style="color:#f92672">=</span> {CF_HDROP, NULL, DVASPECT_CONTENT, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, TYMED_HGLOBAL};
</span></span><span style="display:flex;"><span>        STGMEDIUM stg <span style="color:#f92672">=</span> {TYMED_HGLOBAL};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (FAILED(pDO<span style="color:#f92672">-&amp;</span>gt;GetData(<span style="color:#f92672">&amp;</span>amp;fmt,<span style="color:#f92672">&amp;</span>amp;stg)))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> E_INVALIDARG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Get a pointer to the actual data.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        HDROP hDrop <span style="color:#f92672">=</span> (HDROP)GlobalLock(stg.hGlobal);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hDrop)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> E_INVALIDARG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        UINT numFiles <span style="color:#f92672">=</span> DragQueryFile(hDrop, <span style="color:#ae81ff">0xFFFFFFFF</span>, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(numFiles)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            WCHAR fileName[MAX_PATH] <span style="color:#f92672">=</span> <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span>(UINT i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&amp;</span>lt;numFiles; <span style="color:#f92672">++</span>i)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(DragQueryFile(hDrop, i, fileName, MAX_PATH))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// add file names to filename list to moved/copied
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    m_srcFileNames.Add(fileName);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        GlobalUnlock(stg.hGlobal);
</span></span><span style="display:flex;"><span>        ReleaseStgMedium(<span style="color:#f92672">&amp;</span>amp;stg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// get destination folder:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>SHGetPathFromIDList(pidlFolder, m_destFolder))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> E_INVALIDARG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Code snippet for IContextMenu::QueryContextMenu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    STDMETHODIMP TrapCopy<span style="color:#f92672">::</span>QueryContextMenu(HMENU hmenu,
</span></span><span style="display:flex;"><span>                                            UINT uMenuIndex,
</span></span><span style="display:flex;"><span>                                            UINT uidFirstCmd,
</span></span><span style="display:flex;"><span>                                            UINT uidLastCmd,
</span></span><span style="display:flex;"><span>                                            UINT uFlags)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If the flags include CMF_DEFAULTONLY or if pipe client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// is not connected don&#39;t do anything.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (uFlags <span style="color:#f92672">&amp;</span>amp; CMF_DEFAULTONLY)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> MAKE_HRESULT(SEVERITY_SUCCESS, FACILITY_NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> cmd <span style="color:#f92672">=</span> uidFirstCmd;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        InsertMenu(hmenu, uMenuIndex<span style="color:#f92672">++</span>, MF_STRING<span style="color:#f92672">|</span>MF_BYPOSITION, cmd <span style="color:#f92672">++</span>, <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;Custom copy&#34;</span>);
</span></span><span style="display:flex;"><span>        InsertMenu(hmenu, uMenuIndex<span style="color:#f92672">++</span>, MF_STRING<span style="color:#f92672">|</span>MF_BYPOSITION, cmd <span style="color:#f92672">++</span>, <span style="color:#e6db74">&#34;Custom paste&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the copy/paste default handler to the menu item create above
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> defItem <span style="color:#f92672">=</span> GetMenuDefaultItem(hmenu, false, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (defItem <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// 1: Copy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>            SetMenuDefaultItem(hmenu, uidFirstCmd <span style="color:#f92672">+</span> defItem <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, false);      
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (defItem <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) <span style="color:#75715e">// 2: Move
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>            SetMenuDefaultItem(hmenu, uidFirstCmd <span style="color:#f92672">+</span> defItem <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, false);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Return 2 to tell the shell that we added 2 top-level menu items.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MAKE_HRESULT</span>(SEVERITY_SUCCESS, FACILITY_NULL, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    STDMETHODIMP TrapCopy<span style="color:#f92672">::</span>InvokeCommand ( LPCMINVOKECOMMANDINFO pInfo )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(HIWORD(pInfo<span style="color:#f92672">-&amp;</span>gt;lpVerb))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> E_INVALIDARG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// custom implementaion for copy/move for source files m_srcFileNames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// and destination folder m_destFolder, saved in TrapCopy::Initialize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span>(LOWORD(pInfo<span style="color:#f92672">-&amp;</span>gt;lpVerb))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            InvokeCustomCopy()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            InvokeCustomeMove()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> S_OK;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><hr>

    <a href="/"> >> Home</a>
  </main>
  <div class="disqus-comments">                  
    <button id="show-comments" class="btn btn-default" type="button" 
    style="margin-left: auto;margin-right: auto;display: block;">Show <span class="disqus-comment-count" data-disqus-url="https://xosh.org/catch-copy-paste-from-explorer-using-shell-extension">comments</span>
    </button>
    <div id="disqus_thread"></div>
  </div>
  <script id="dsq-count-scr" src="//smusamashah.disqus.com/count.js" async></script>
  <script>
    (function(){
      let showCommentsBtn = document.getElementById("show-comments");
      showCommentsBtn.onclick = function(){
        var disqus_shortname = 'smusamashah';
    
        (function() {
          var disqus = document.createElement('script'); 
          disqus.type = 'text/javascript'; 
          disqus.async = true;
          disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
        })();
    
        showCommentsBtn.style.display="none"; 
      };
    })();
  </script>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/smusamashah">Github</a> | <a href="https://www.linkedin.com/in/smusamashah/">LinkedIn</a> | <a href="/cv">Resume</a>
      
    </footer>
  </body>
</html>

